<div class="container mx-auto p-4">
  <h2 class="text-2xl font-bold mb-4">Demande de Collecte</h2>
  <form [formGroup]="collectionForm" (ngSubmit)="onSubmit()">
    <div class="mb-8 p-4 border rounded-lg shadow-lg">
      <!-- Types de déchets -->
      <div formArrayName="wasteTypes" class="grid grid-cols-2 gap-4 mb-4">
        <div *ngFor="let wasteType of getWasteTypesControls(); let i = index"
             [formGroupName]="i"
             class="p-4 border rounded-lg">
          <h4 class="text-lg font-semibold mb-2">Type de déchet #{{ i + 1 }}</h4>

          <div class="mb-2">
            <label class="block text-sm font-medium text-gray-700">Type de déchet</label>
            <select
              formControlName="type"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
              (change)="checkTypeDuplication(i)"
            >
              <option value="">Sélectionnez un type</option>
              <option *ngFor="let type of getAvailableWasteTypes(i)" [value]="type">{{ type }}</option>
            </select>
            <div *ngIf="wasteType.get('type')?.errors?.['required'] && wasteType.get('type')?.touched"
                 class="text-red-500 text-sm mt-1">
              Le type de déchet est requis
            </div>
          </div>

          <div class="mb-2">
            <label class="block text-sm font-medium text-gray-700">Poids (en grammes)</label>
            <input
              type="number"
              formControlName="weight"
              class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
              min="1000"
            >
            <div *ngIf="wasteType.get('weight')?.errors?.['required'] && wasteType.get('weight')?.touched"
                 class="text-red-500 text-sm mt-1">
              Le poids est requis
            </div>
            <div *ngIf="wasteType.get('weight')?.errors?.['min'] && wasteType.get('weight')?.touched"
                 class="text-red-500 text-sm mt-1">
              Le poids minimum est de 1000g
            </div>
          </div>

          <button
            type="button"
            (click)="removeWasteType(i)"
            class="px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300"
          >
            Supprimer
          </button>
        </div>
      </div>

      <!-- Bouton Ajouter -->
      <button
        type="button"
        (click)="addWasteType()"
        *ngIf="getWasteTypesControls().length < 4"
        class="mt-2 px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300"
      >
        Ajouter un type de déchet
      </button>

      <!-- Total Weight Display -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-gray-700">Poids Total (en grammes)</label>
        <input
          type="number"
          formControlName="totalWeight"
          readonly
          class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm"
        >
        <div *ngIf="collectionForm.get('wasteTypes')?.hasError('maxTotalWeight')"
             class="text-red-500 text-sm mt-1">
          Le poids total ne doit pas dépasser 10000g
        </div>
      </div>

      <!-- Address -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Adresse de collecte</label>
        <input
          type="text"
          formControlName="address"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
        >
        <div *ngIf="collectionForm.get('address')?.errors?.['required'] && collectionForm.get('address')?.touched"
             class="text-red-500 text-sm mt-1">
          L'adresse est requise
        </div>
      </div>

      <!-- Date -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Date de collecte</label>
        <input
          type="date"
          formControlName="date"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
        >
        <div *ngIf="collectionForm.get('date')?.errors?.['required'] && collectionForm.get('date')?.touched"
             class="text-red-500 text-sm mt-1">
          La date est requise
        </div>
      </div>

      <!-- Time Slot -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Créneau horaire</label>
        <select
          formControlName="timeSlot"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
        >
          <option value="">Sélectionnez un créneau</option>
          <option *ngFor="let slot of timeSlots" [value]="slot">{{ slot }}</option>
        </select>
        <div *ngIf="collectionForm.get('timeSlot')?.errors?.['required'] && collectionForm.get('timeSlot')?.touched"
             class="text-red-500 text-sm mt-1">
          Le créneau horaire est requis
        </div>
      </div>

      <!-- Notes -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700">Notes supplémentaires</label>
        <textarea
          formControlName="notes"
          rows="3"
          class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50"
        ></textarea>
        <div *ngIf="collectionForm.get('notes')?.errors?.['required'] && collectionForm.get('notes')?.touched"
             class="text-red-500 text-sm mt-1">
          Les notes sont requises
        </div>
      </div>

      <!-- Submit Button -->
      <button
        type="submit"
        [disabled]="collectionForm.invalid"
        class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 disabled:opacity-50 disabled:cursor-not-allowed w-full"
      >
        Soumettre la demande
      </button>
    </div>
  </form>
</div>
